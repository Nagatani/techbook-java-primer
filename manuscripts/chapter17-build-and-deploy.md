# 第22章 アプリケーションのビルドと配布

## 🎯総合演習プロジェクトへのステップ

本章で学ぶビルドと配布の技術は、開発した**総合演習プロジェクト「ToDoリストアプリケーション」** を、Java開発環境がない友人やほかのユーザーにも使ってもらうための最終ステップです。

- **実行可能JARファイルの作成**: アプリケーションの全クラスファイル（`Task.class`, `TaskListPanel.class`など）を1つの実行可能な`todo-app.jar`ファイルにまとめます。これにより、ユーザーは`java -jar todo-app.jar`という簡単なコマンドだけでアプリケーションを起動できます。
- **`jpackage`によるネイティブアプリケーション化**: さらに一歩進んで、`jpackage`を使い、Windowsユーザー向けには`.exe`インストーラを、macOSユーザー向けには`.dmg`インストーラを作成します。これにより、ユーザーはJavaのインストールを意識することなく、普段使いのアプリケーションと同じようにインストールして利用できるようになり、配布のハードルが劇的に下がります。

## 22.1 なぜビルドと配布が必要か？

これまでの章では、主にIDE（統合開発環境）から直接ソースコードを実行してきました。しかし、開発したアプリケーションをほかの人に使ってもらうには、ソースコードそのものを渡すわけにはいきません。

ユーザーがJava開発環境を持っていない場合でも簡単に実行できるように、必要なファイルをすべて1つにまとめ、実行可能な形式に変換する必要があります。この一連の作業を「**ビルド**」と「**パッケージング**」と呼び、最終的にユーザーに渡せる形にすることを「**配布**」と言います。

本章では、Javaアプリケーションを配布するための最も基本的な形式である**実行可能JARファイル**の作成方法と、さらに一歩進んでOSネイティブのアプリケーションを作成する方法を学びます。

## 22.2 実行可能JARファイルの作成

**JAR (Java Archive)** は、複数のJavaクラスファイルや、画像・設定ファイルなどのリソースを、ZIP形式で1つにまとめたファイルです。このJARファイルに「どのクラスの`main`メソッドからプログラムを開始するか」という情報を加えることで、ダブルクリックや簡単なコマンドで実行できる「実行可能JARファイル」を作成できます。

### ステップ1: サンプルアプリケーションの準備

まずは、配布する簡単なSwingアプリケーションを用意します。

```java
// SimpleApp.java
import javax.swing.*;

public class SimpleApp {
    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            JFrame frame = new JFrame("配布アプリ");
            frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
            frame.setSize(300, 150);
            frame.add(new JLabel("JARファイルからの実行に成功しました！"));
            frame.setLocationRelativeTo(null);
            frame.setVisible(true);
        });
    }
}
```

### ステップ2: コンパイル

まず、ソースコードをコンパイルしてクラスファイル (`.class`) を作成します。

```bash
javac SimpleApp.java
```
これにより、`SimpleApp.class`ファイルが生成されます。

### ステップ3: マニフェストファイルの作成

次に、JARファイルに「メインクラスは何か」を教えるための**マニフェストファイル**を作成します。`manifest.txt`という名前で、以下の内容を記述します。

```text
Main-Class: SimpleApp

```
**【重要】**: `Main-Class:`の後には半角スペースが1つ必要です。また、**ファイルの末尾には必ず改行を入れてください。** 改行がないと正しく認識されない場合があります。

### ステップ4: `jar`コマンドによるパッケージング

`jar`コマンドを使って、クラスファイルとマニフェストファイルを1つのJARファイルにまとめます。

```bash
# 書式: jar cvfm [出力JARファイル名] [マニフェストファイル名] [含めるクラスファイル]
jar cvfm SimpleApp.jar manifest.txt SimpleApp.class
```
コマンドの各オプションの意味は以下のとおりです。
- `c`: 新しいアーカイブを作成する (create)
- `v`: 詳細な情報を表示する (verbose)
- `f`: 作成するファイル名を指定する (file)
- `m`: 指定されたマニフェストファイルを取り込む (manifest)

このコマンドを実行すると、`SimpleApp.jar`という実行可能なJARファイルが作成されます。

### ステップ5: 実行

作成したJARファイルは、`java -jar`コマンドで実行できます。

```bash
java -jar SimpleApp.jar
```
多くのデスクトップ環境では、このJARファイルをダブルクリックするだけでもアプリケーションが起動します。これで、Java開発環境がない人にもアプリケーションを配布できるようになりました。

### IntelliJ IDEAでのJARファイル作成
IntelliJ IDEAでは、GUI操作で実行可能JARファイルを生成できます。
1.  `File` -> `Project Structure...` を選択します。
2.  `Artifacts` -> `+` -> `JAR` -> `From modules with dependencies...` を選択します。
3.  `Main Class`として実行したいクラス（例： `SimpleApp`）を選択し、OKを押します。
4.  メニューの `Build` -> `Build Artifacts...` -> `(作成したArtifact名)` -> `Build` を選択すると、`out/artifacts`ディレクトリ以下にJARファイルが生成されます。

## 22.3 （応用）`jpackage`によるネイティブアプリケーション化

JARファイルは便利ですが、実行するにはユーザーのPCにJavaランタイム（JRE）がインストールされている必要があります。

Java 14から導入された`jpackage`ツールを使えば、**アプリケーションと必要なJavaランタイムを丸ごとパッケージングし、OS標準のインストーラや実行ファイル（Windowsなら`.exe`、Macなら`.app`）を作成できます。** これにより、ユーザーはJavaの存在を意識することなく、普段使いのアプリケーションと同じようにインストール・実行できます。

### `jpackage`を使うための準備：入力と出力の分離

`jpackage`でエラーを起こさないための重要なポイントは、**「パッケージ化の材料（入力）が入ったディレクトリ」と「作成されたアプリケーション（出力）を保存するディレクトリ」**を完全に分けることです。

```
/MyProject/
|
|-- input/
|   └── SimpleApp.jar  <-- 先ほど作成したJARファイルをここに置く
|
|-- output/
|   └── (完成したアプリはここに作られる)
|
`-- SimpleApp.java (ソースコードなど)
```

### `jpackage`の実行例

プロジェクトのルートディレクトリ (`/MyProject/`) で、以下のコマンドを実行します。

```bash
jpackage --type app-image \
          --name "SimpleApp" \
          --input ./input \
          --main-jar SimpleApp.jar \
          --dest ./output
```
- `--type app-image`: アプリケーションイメージを作成します。インストーラ形式にしたい場合は、OSに応じて`dmg`(macOS), `msi`(Windows), `rpm`/`deb`(Linux)などを指定します。
- `--name "SimpleApp"`: アプリケーションの名前を指定します。
- `--input ./input`: パッケージ化の材料（JARファイル）が入っているディレクトリを指定します。
- `--main-jar SimpleApp.jar`: 入力ディレクトリ内の、メインとなるJARファイル名を指定します。
- `--dest ./output`: 完成したアプリケーションを保存するディレクトリを指定します。

コマンドが成功すると、`output`ディレクトリ内に`SimpleApp`という名前のアプリケーションが作成されます。これは、Javaランタイムを含んだ自己完結型のアプリケーションであり、ほかのユーザーにそのまま配布できます。

`jpackage`は、Javaアプリケーションをより多くのユーザーに届けるための非常に強力なツールです。

## まとめ

本章では、開発したJavaアプリケーションをほかのユーザーに届けるための基本的な手法を学びました。

- **JARファイル**は、Javaのクラスファイルやリソースをまとめる標準的な方法です。
- **マニフェストファイル**に`Main-Class`を記述することで、実行可能なJARファイルを作成できます。
- **`java -jar`コマンド**で、実行可能JARファイルを起動できます。
- **`jpackage`ツール**を使えば、Javaランタイムを同梱した、より配布しやすいネイティブアプリケーションを作成できます。

ソフトウェア開発は、コードを書くだけでなく、それを価値ある成果物としてユーザーに届けるところまでが含まれます。本章で学んだビルドと配布の知識は、あなたの作品を世界に公開するための第一歩です。